# יומן פיתוח (Walkthrough)

## 2026-01-18 21:00

### מערכת חיתוך תמונות מלאה (Image Crop System)

יישום מערכת מקיפה לחיתוך, זום והזזת תמונות בכל הפרויקט. המערכת עברה מספר שלבים של פיתוח ותיקון עד להשגת עקביות מלאה.

---

#### שלב 1: יצירת תשתית החיתוך

**קומפוננטות חדשות שנוצרו:**

1. **`ImageCropEditor.svelte`** - עורך חיתוך אינטראקטיבי
   - גרירה (Drag) - הזזת מיקום התמונה עם עכבר או מגע
   - זום (Zoom) - הגדלה/הקטנה באמצעות גלגלת עכבר או כפתורים (+/-)
   - איפוס - חזרה למצב ברירת מחדל (מרכז, זום 100%)
   - אישור/ביטול - שמירה או ביטול השינויים
   - תמיכה מלאה ב-Touch Events למכשירים ניידים

2. **`ImageDisplay.svelte`** - קומפוננטה אחידה להצגת תמונות
   - תמיכה בתמונות עם ובלי נתוני חיתוך
   - טעינה מ-IndexedDB או מ-static files
   - מצב טעינה אוטומטי עם אינדיקטור
   - תמיכה לאחור (Backward compatibility) - מקבל `string` או `ImageData`

3. **`imageStore.svelte.ts`** - Store מרכזי לניהול מטאדאטה של תמונות
   - אחסון נתוני חיתוך בנפרד מהתמונות עצמן
   - מבנה: `{ [imageId: string]: ImageMetadata }`
   - שיטות: `getImageMetadata`, `setImageMetadata`, `updateImageMetadata`, `deleteImageMetadata`

**שדרוג קומפוננטות קיימות:**

- **`ImageUploader.svelte`** - שודרג לתמוך בעריכת חיתוך:
  - פתיחת עורך חיתוך אוטומטית אחרי בחירת תמונה
  - כפתור "✂️ ערוך חיתוך" לתמונות קיימות
  - שמירת נתוני crop ב-`imageStore`

**מבני נתונים חדשים:**

```typescript
// src/lib/types.ts
interface ImageCropData {
  x: number;      // מיקום X באחוזים (0-100)
  y: number;      // מיקום Y באחוזים (0-100)
  scale: number;  // זום יחסי (1.0 = minScale, 2.0 = פי 2)
}

interface ImageMetadata {
  crop?: ImageCropData;
}

interface ImageData {
  src: string;
}

// הוספה ל-AppState
interface AppState {
  // ... שאר השדות
  images: { [id: string]: ImageMetadata };
}
```

**ארכיטקטורה - הפרדת נתונים:**

במקום לשמור `ImageData` ישירות בתוך `Task`, `UserProfile` ו-`List`, עברנו לארכיטקטורה מנורמלת:
- `Task.imageSrc`, `UserProfile.avatar`, `List.logo` - מחזיקים רק `string` (ID של התמונה)
- `AppState.images` - מחזיק את כל המטאדאטה (כולל נתוני crop) במקום מרכזי
- יתרונות: הפחתת כפילויות, ניהול קל יותר, גמישות בהוספת שדות עתידיים

---

#### שלב 2: אינטגרציה בכל הפרויקט

**החלפת כל תצוגות התמונות ב-`ImageDisplay`:**

קומפוננטות שעודכנו:
- ✅ `TaskRow.svelte` - תמונות משימות
- ✅ `UserSelector.svelte` - אווטרים של משתמשים
- ✅ `ListSwitcher.svelte` - לוגו של רשימות
- ✅ `CelebrationModal.svelte` - תמונות במודאל חגיגה
- ✅ `AddModal.svelte` - תצוגה מקדימה של תמונות
- ✅ `settings/users/+page.svelte` - ניהול אווטרים
- ✅ `settings/lists/+page.svelte` - ניהול לוגו רשימות
- ✅ `+page.svelte` - דף ראשי (אווטר המשתמש המחובר)

**שירותים שעודכנו:**

- **`migration.ts`** - הוספת migration (גרסה 6):
  - העברת נתוני `crop` מתוך `Task.imageSrc`, `UserProfile.avatar`, `List.logo`
  - יצירת `AppState.images` והעברת המטאדאטה אליו
  - המרת הפרופרטיז המקוריים ל-`string` פשוט (ID בלבד)

- **`backupController.svelte.ts`** - עדכון לוגיקת Backup/Restore:
  - Hydration: המרת `idb:xxx` ל-data URLs לפני ייצוא
  - Dehydration: המרת data URLs חזרה ל-`idb:xxx` אחרי ייבוא
  - טיפול נכון ב-`AppState.images` והפניות אליו

---

#### שלב 3: תיקון בעיית העקביות (הבעיה המרכזית)

**הבעיה שהתגלתה:**

תמונות עם חיתוך נראו **שונות לחלוטין** בכל מקום:
- עורך החיתוך (400px) - הציג את התמונה המלאה ✓
- ImageUploader במודאל (150px) - הציג חלק אחר (עורף) ✗
- רשימת המשימות (120px) - הציג חלק שלישי ✗

**3 סיבות שורש:**

1. **Scale מוחלט במקום יחסי**
   - הבעיה: שמרנו `scale: 0.333` (ערך מוחלט שעובד רק עם קונטיינר 400px)
   - כשהתמונה הוצגה בקונטיינר 120px, ה-scale היה שגוי לחלוטין
   - הפתרון: שמירת `scale` **יחסי** ל-`minScale` (1.0 = minScale, 1.4 = פי 1.4 מ-minScale)

2. **`ImageDisplay` ניהלה גדלים בעצמה**
   - הבעיה: prop `size="small|medium|large|full"` הגדיר גודל קבוע (60px, 120px, 200px, 100%)
   - זה יצר אי-עקביות כי הקומפוננטה "החליטה" על הגודל במקום ה-parent
   - הפתרון: הפיכת `ImageDisplay` לגנרית לחלוטין - תמיד 100% × 100% של ה-parent

3. **`minScale` מחושב ב-`$derived` (באג Svelte)**
   - הבעיה: `$derived` לא מתעדכן כש-`naturalWidth/Height` של התמונה משתנים
   - זה גרם ל-`minScale` להישאר 1 במקום להתעדכן לערך הנכון
   - הפתרון: חישוב `minScale` **פעם אחת** ב-`handleLoad()` אחרי שהתמונה נטענת

**התיקונים שבוצעו:**

**`ImageCropEditor.svelte`:**
```typescript
// לפני - scale מוחלט
crop = { x: 50, y: 50, scale: minScale }; // ← minScale משתנה לפי קונטיינר!

// אחרי - scale יחסי
crop = { x: 50, y: 50, scale: 1.0 }; // ← 1.0 = minScale, 2.0 = פי 2

// שימוש בתצוגה:
style:transform="translate(-50%, -50%) scale({minScale * crop.scale})"
```

**`ImageDisplay.svelte`:**
```typescript
// לפני - $derived לא עובד!
let minScale = $derived.by(() => {
  if (!imageRef || !containerRef) return 1;
  const containerSize = containerRef.offsetWidth;
  const scaleByWidth = containerSize / imageRef.naturalWidth;
  const scaleByHeight = containerSize / imageRef.naturalHeight;
  return Math.max(scaleByWidth, scaleByHeight);
});

// אחרי - חישוב פעם אחת ב-handleLoad
let minScale = $state(1);

function handleLoad() {
  if (imageRef && containerRef) {  // ← הסרת תנאי cropData!
    const containerSize = containerRef.offsetWidth;
    const scaleByWidth = containerSize / imageRef.naturalWidth;
    const scaleByHeight = containerSize / imageRef.naturalHeight;
    minScale = Math.max(scaleByWidth, scaleByHeight);
  }
  imageLoaded = true;
  onload?.();
}
```

```css
/* לפני - גדלים קבועים */
.size-small { width: 60px; height: 60px; }
.size-medium { width: 120px; height: 120px; }
.size-large { width: 200px; height: 200px; }
.size-full { width: 100%; aspect-ratio: 1; }

/* אחרי - גנרי לחלוטין */
.image-display {
  width: 100%;
  height: 100%;
}
```

**הסרת `size` prop מכל מקומות השימוש:**

```svelte
<!-- לפני -->
<ImageDisplay imageSrc={task.imageSrc} size="medium" />

<!-- אחרי - הגודל נקבע על ידי ה-parent -->
<div style="width: 120px; height: 120px;">
  <ImageDisplay imageSrc={task.imageSrc} />
</div>
```

**`ImageUploader.svelte` - Dog-fooding:**

הקומפוננטה עברה רפקטור להשתמש ב-`ImageDisplay` לתצוגה מקדימה (במקום לוגיקה משלה):
```svelte
<!-- לפני - לוגיקה כפולה -->
<div class="preview-image-cropped">
  <img use:dbImage={currentImageSrc} ... />
</div>

<!-- אחרי - שימוש ב-ImageDisplay -->
<div class="preview-wrapper">
  <ImageDisplay 
    imageSrc={currentImageSrc}
    alt={alt}
    className="preview-image-display"
  />
</div>
```

---

#### שלב 4: תיקוני עיצוב ועקביות (השלמה)

**2 באגים קריטיים שנותרו:**

1. **`minScale` לא מחושב כשאין `cropData`**
   - הבעיה: התנאי `if (imageRef && containerRef && cropData)` ב-`handleLoad()`
   - גרם לתמונות **ללא** חיתוך להיות בגודל שגוי
   - הפתרון: הסרת `&& cropData` - חישוב `minScale` **תמיד**

2. **`ImageUploader` ללא גודל מוגדר**
   - הבעיה: אחרי שהפכנו את `ImageDisplay` לגנרית, ה-wrapper לא הגדיר גודל
   - גרם לתמונה להתמוטט ל-0px
   - הפתרון: הוספת `width: 150px; height: 150px;` ל-CSS

**שוליים עגולות לכל התמונות:**

- `TaskRow.svelte`: הוספת `border-radius: 12px` + `overflow: hidden` ל-`.task-image-wrapper`
- `ImageUploader.svelte`: הוספת `border-radius: 12px` + `overflow: hidden` לתצוגה מקדימה
- קומפוננטות אחרות: כבר היו עם שוליים עגולות או עיגול מלא (אווטרים)
- **החלטה**: לא לשנות את `ImageDisplay` עצמה (שמירה על גנריות)

**גובה שורות זהה:**

- הבעיה: `TaskRow` עם `max-height: 180px; min-height: 100px;` גרם לגבהים שונים
- הפתרון: `height: 120px;` קבוע
- תוצאה: כל השורות באותו גובה בדיוק

**פרופורציות במודאל חגיגה:**

- הבעיה: `CelebrationModal` עם `width: 100%; height: 120px;` **בלי** `aspect-ratio: 1`
- גרם לתמונות להיות רחבות במקום מרובעות
- הפתרון: הוספת `aspect-ratio: 1;` + שינוי `width` ל-`auto`

---

#### בדיקות מקיפות בדפדפן

לאחר כל תיקון, בוצעו בדיקות יסודיות:
- ✅ רענון דפדפן והמתנה לטעינה מלאה
- ✅ כניסה למצב עריכה
- ✅ פתיחת מודאל עריכת משימה
- ✅ פתיחת עורך החיתוך
- ✅ שינוי זום ל-140% (4 לחיצות על +)
- ✅ שמירה ובדיקת עקביות ב-3 מקומות:
  - עורך החיתוך (400px)
  - ImageUploader במודאל (150px)
  - רשימת המשימות (120px)
- ✅ בדיקת מודאל החגיגה (סימון משימה כבוצעת)
- ✅ צילומי מסך לאימות ויזואלי

---

#### סיכום התוצאות

**לפני:**
- ❌ תמונות עם חיתוך נראות שונות בכל מקום
- ❌ תמונות ללא חיתוך בגודל שגוי
- ❌ ImageUploader מתמוטט ל-0px
- ❌ שורות בגבהים שונים
- ❌ תמונות ללא שוליים עגולות
- ❌ תמונות במודאל חגיגה רחבות ולא מרובעות

**אחרי:**
- ✅ **עקביות מלאה** - כל התמונות נראות זהות בכל המקומות
- ✅ חיתוך עובד בצורה זהה בכל גודל קונטיינר
- ✅ ImageUploader עם גודל קבוע (150px × 150px)
- ✅ כל השורות בגובה זהה (120px)
- ✅ כל התמונות עם פינות מעוגלות (`border-radius: 12px`)
- ✅ תמונות במודאל חגיגה מרובעות (`aspect-ratio: 1`)

---

#### קבצים שנוצרו/שונו

**קבצים חדשים:**
```
sveltekit-version/
├── src/lib/components/
│   ├── ImageCropEditor.svelte       (עורך חיתוך אינטראקטיבי)
│   ├── ImageDisplay.svelte          (תצוגת תמונות אחידה)
│   └── FloatingIframe.svelte        (עזר לבדיקות)
├── src/lib/stores/
│   └── imageStore.svelte.ts         (ניהול מטאדאטה של תמונות)
├── src/routes/
│   └── test-board/+page.svelte      (דף בדיקות)
└── docs/
    └── image-crop-feature.md        (תיעוד הפיצ'ר)
```

**קבצים ששונו:**
```
sveltekit-version/
├── src/lib/
│   ├── types.ts                     (ImageCropData, ImageMetadata, AppState.images)
│   ├── data/defaults.ts             (INITIAL_STATE.images)
│   ├── config.ts                    (קונפיגורציה)
│   ├── components/
│   │   ├── ImageUploader.svelte     (אינטגרציה עם עורך + dog-fooding)
│   │   ├── TaskRow.svelte           (שוליים עגולות + גובה קבוע)
│   │   ├── CelebrationModal.svelte  (פרופורציות + שוליים)
│   │   ├── AddModal.svelte          (שימוש ב-imageStore)
│   │   ├── ListSwitcher.svelte      (שימוש ב-ImageDisplay)
│   │   └── UserSelector.svelte      (שימוש ב-ImageDisplay)
│   ├── logic/
│   │   ├── tasksBoard.svelte.ts     (עדכון טיפוסים)
│   │   └── backupController.svelte.ts (hydration/dehydration)
│   ├── services/
│   │   ├── migration.ts             (migration v6 - העברת crop data)
│   │   └── language.ts              (טקסטים)
│   └── stores/
│       ├── persistence.ts           (שמירת images)
│       └── listStore.svelte.ts      (עדכון טיפוסים)
└── src/routes/
    ├── +page.svelte                 (שימוש ב-ImageDisplay)
    └── settings/
        ├── users/+page.svelte       (שימוש ב-ImageDisplay + imageStore)
        └── lists/+page.svelte       (שימוש ב-ImageDisplay + imageStore)
```

---

#### החלטות עיצוב ואדריכליות

1. **שמירה על גנריות `ImageDisplay`**: 
   - לא הוספנו `border-radius` ישירות לקומפוננטה
   - העיצוב מוגדר ב-parent containers
   - מאפשר גמישות ושימוש חוזר

2. **גובה קבוע במקום גמיש**: 
   - שינוי מ-`max-height` + `min-height` ל-`height` קבוע
   - מבטיח עקביות ויזואלית מלאה

3. **Scale יחסי במקום מוחלט**:
   - `crop.scale` יחסי ל-`minScale`
   - מאפשר עקביות בכל גודל קונטיינר

4. **הפרדת מטאדאטה מנתונים**:
   - `AppState.images` מרכזי
   - הפניות פשוטות (string IDs) ב-entities
   - מונע כפילויות ומקל על ניהול

---

#### מעקפים ופתרונות טכניים

1. **חישוב `minScale` ב-`handleLoad` במקום `$derived`**:
   - ה-`$derived` של Svelte לא מתעדכן כש-`naturalWidth/Height` משתנים
   - פתרון: חישוב חד-פעמי אחרי טעינת התמונה

2. **Dog-fooding ב-`ImageUploader`**:
   - שימוש ב-`ImageDisplay` במקום לוגיקה כפולה
   - מבטיח עקביות ומפחית code duplication

3. **תמיכה לאחור מלאה**:
   - `ImageDisplay` מקבל גם `string` וגם `ImageData`
   - Migration אוטומטי של נתונים ישנים
   - אין צורך בשינויים ידניים

---

#### תיעוד נוסף

- **`sveltekit-version/docs/image-crop-feature.md`** - תיעוד מפורט של הפיצ'ר
- **`temp/image-crop-summary.md`** - סיכום תהליך התיקון

---

## 2026-01-14 18:50

### אימות מול גוגל ושיפורי בנייה

### שינויים שבוצעו

- **מדיניות פרטיות (Privacy Policy)**:

  - הוספת דף `/privacy` סטטי ומותאם לדרישות האימות של גוגל (Google Verification).
  - הדף מצהיר כי בסיס הנתונים הוא לוקאלי/פרטי בלבד ואינו נאסף ע"י המפתח.
  - נוסף קובץ `package.json` מעודכן עם סקריפט `deploy` מקוצר.

- **שיפורי בניה (Build Optimization)**:
  - **פתרון בעיית ייבוא דינמי**: החלפת `import(...)` דינמי בייבוא סטטי ב-`globalState.svelte.ts` עבור `migrationService`.
  - השינוי פתר אזהרות ב-Vite ומנע שגיאות בזמן ריצה הקשורות לטעינת מודולים (Chunk loading).

---

## 2026-01-14 02:15

### רה-ארגון דף הגדרות (Routing Refactor)

### שינויים שבוצעו

- **שינוי ארכיטקטורת ניווט**:

  - מעבר מדף יחיד (`settings/+page.svelte`) המנהל טאבים בתנאי (`if/else`), למבנה מבוסס נתיבים (Routing).
  - **Layout**: יצירת `settings/+layout.svelte` המרכז את הכותרת והניווט העליון.
  - **Pages**: פיצול התוכן ל-3 דפים נפרדים: `users`, `lists`, `general`.
  - **Redirect**: דף הבית של ההגדרות מפנה אוטומטית ללשונית המשתמשים.

- **יתרונות**:
  - אפשרות לקישור ישיר (Deep Linking) ללשונית ספציפית (למשל `/settings/general`).
  - ניהול קוד נקי יותר וחלוקה לקבצים קטנים.
  - שיפור ביצועים (טעינת קוד רלוונטי בלבד).

### שיפורי תשתית (Google SDK)

- **החלפת מימוש HTTP ב-SDK רשמי**:
  - הוחלפו קריאות `fetch` ידניות בשימוש ישיר ב-`gapi.client.drive.files.create` וב-`gapi.client.request`.
  - השינוי מבטיח תאימות טובה יותר לטיפוסים (Types) ומנצל את מנגנון הטיפול בטוקנים של הספרייה.

## 2026-01-14 02:00

### סנכרון ופתרון קונפליקטים (Google Drive)

### שינויים שבוצעו

- **ניהול גרסאות נתונים (`lastModified`)**:

  - הוספת שדה `lastModified` ל-`AppState` ולכל הממשקים הרלוונטיים.
  - עדכון `persistence.ts` לעדכון החותמת בכל שמירה.
  - עדכון מיגרציות ונתוני ברירת מחדל (`defaults.ts`) לתמיכה בשדה החדש.

- **זיהוי קונפליקטים (`BackupController`)**:

  - פיתוח לוגיקה המשווה את חותמת הזמן של הגיבוי בענן מול המידע המקומי בעת התחברות.
  - זיהוי "גיבוי חדש יותר" (Remote Newer) בפער של מעל 5 שניות.

- **ממשק פתרון קונפליקטים**:

  - שדרוג `GoogleDriveBackup.svelte` עם מודאל אזהרה ייעודי.
  - הצגת השוואה ברורה בין הגרסה המקומית לגרסת הענן (תאריך ושעה).
  - כפתורי בחירה: "עדכן מהענן" (Discards Local) או "השאר מקומי" (Overwrites Cloud next backup).

- **לוקליזציה**:
  - הוספת מחרוזות בעברית לכל תרחישי הקונפליקט ב-`language.ts`.

### הערות טכניות

- המנגנון מונע דריסה דורסנית של מידע במקרה שבו משתמש עובד במקביל (או שכח את האפליקציה פתוחה) במכשיר אחר.

## 2026-01-14 01:50

### גיבוי וסנכרון לגוגל דרייב (ללא שרת)

### שינויים שבוצעו

- **שירות ליבה (`googleDriveService`)**:

  - פיתוח מעטפת (Wrapper) מודרנית ל-Google Identity Services (GIS) ול-Drive API v3.
  - תמיכה מלאה בתהליך OAuth2 בצד הלקוח (Implicit Flow), כולל טיפול בטעינת סקריפטים.
  - פונקציות לגיבוי (Create/Update), שחזור (Get media), ורשימת קבצים.

- **בקר לוגי (`BackupController`)**:

  - ניהול לוגיקת הגיבוי האוטומטי: מאזין לשינויים ב-Store ומבצע גיבוי לאחר השהייה (Debounce) של 5 שניות.
  - ניהול State: מחובר/מנותק, זמן גיבוי אחרון, פרטי משתמש.
  - תמיכה ב-Client ID מותאם אישית דרך ממשק ההגדרות.

- **ממשק משתמש (`GoogleDriveBackup`)**:

  - רכיב חדש בהגדרות המציג את סטטוס החיבור, תמונת המשתמש, וכפתורי פעולה.
  - אפשרות לגיבוי ידני מיידי.
  - מודאל בחירת קובץ לשחזור (במקרה של מעבר מכשיר).

- **אינטגרציה ל-Store**:
  - עדכון `globalState` כך שבכל פעולת שמירה (`save`), נשלחת הודעה לבקר הגיבוי.

### שיפורים ותיקונים (v2)

- **שמירה בתיקייה**: הגיבוי נשמר כעת בתיקייה ייעודית `DailyScheduleBackup` בדרייב, לשמירה על סדר.
- **גיבוי תמונות**: המערכת שולפת תמונות מ-IndexedDB ומטמיעה אותן בקובץ הגיבוי, כך שמעבר מכשיר יעביר גם את התמונות.
- **יציבות חיבור**: נוסף מנגנון שמירת טוקן (Persistence) ב-LocalStorage למניעת ניתוק ברענון הדף, כולל סנכרון מול `gapi`.
- **תיקוני טעינת תמונות**: שימוש בפעולה `use:dbImage` בכל הרכיבים (`CelebrationModal`, `ListSwitcher`) כדי לתמוך בקישורי `idb:`.
- **Typings**: הוספת הגדרות TypeScript לספריות של Google (`@types/gapi`).

### הערות טכניות

- היישום הוא **Serverless** לחלוטין. האימות מתבצע ישירות מול גוגל.
- המידע נשמר כקובץ JSON המכיל את כל הנתונים והתמונות (Base64).

---

## 2026-01-14 01:48

### מיתוג (לוגו) ושיפור דף הכניסה

### שינויים שבוצעו

- **עיצוב גרפי (לוגו)**:

  - עוצב לוגו חדש בפורמט SVG (`src/lib/assets/logo.svg`) תחת הקונספט "סדר יום מובנה". הלוגו מציג 3 כרטיסיות מדורגות, המייצגות רצף וסדר, עם צבעוניות של "צי מלוכה" (Navy) ו"קורל" (Coral) ליצירת מראה מקצועי, נקי אך חם.
  - הלוגו הוגדר גם כ-favicon של האתר.

- **דף כניסה (UserSelector)**:

  - שדרוג העיצוב: הלוגו מופיע כעת לצד שם האפליקציה ("סדר יום ויזואלי") בכותרת העליונה.
  - שיפור היררכיה: הפרדה ברורה בין המיתוג (Header) לבין ההנחיה למשתמש ("מי משתמש בלוח היום?").

- **מטא-דאטה**:
  - שם האפליקציה עודכן רשמית ב-`language.ts` ל-"סדר יום ויזואלי".

---

## 2026-01-14 01:36

### ליטוש חוויית חגיגה ומשוב קולי

### שינויים שבוצעו

- **ממשק חגיגה (Celebration Modal)**:

  - שדרוג `CelebrationModal.svelte` לתמיכה במצבי "משימה" ו"כללי".
  - המודאל כעת מציג באופן ויזואלי את המשימה שהושלמה, מחמאה מודגשת, ואת המשימה הבאה בתור (עם תצוגה מקדימה).
  - אינטגרציה מלאה עם נתוני המשתמש (שם, תמונה) והמגדר.

- **לוגיקת משוב (Feedback Logic)**:

  - עדכון `tasksBoard.svelte.ts` לשימוש ב-`boostService` וב-`audioSequencer`.
  - הוספת המתנה (`await`) לסיום ניגון רצף האודיו המלא לפני סגירה אוטומטית של המודאל.
  - טיפול במקרי קצה: סיום כל המשימות, או חגיגה כללית (גיבוי/פעולה אחרת) ללא הקשר משימה.

- **תוכן ומשאבים**:
  - עדכון `defaults.ts` ו-`language.ts` עם נתונים התומכים בלוגיקה החדשה.
  - הכנה לתמיכה בגיבוי בענן (הוספת תשתית בקבצי הליבה).

### בדיקות

- וידוא סנכרון בין האודיו (TTS/קבצים) לבין הופעת המודאל.
- בדיקת זרימה של השלמת משימה -> חגיגה -> סגירה.

---

## 2026-01-14 01:25

### הפרדת דף בחירת משתמש ושיפור טעינה

### שינויים שבוצעו

- **ארכיטקטורה וניווט**:

  - **הפרדת נתיב**: מסך בחירת המשתמש (`UserSelector`) הועבר משילוב בדף הבית לנתיב ייעודי ועצמאי: `/login`.
  - **ניהול הפניות**: הדף הראשי (`/`) כעת בודק את סטטוס הטעינה והחיבור. משתמש לא מחובר מופנה ל-`/login` (לאחר טעינה), ומשתמש מחובר נשאר בלוח.

- **חוויית טעינה (UX)**:

  - **Splash Screen**: יצירת רכיב `src/lib/components/SplashScreen.svelte` המציג אנימציית טעינה נקייה וממותגת. רכיב זה מוצג בזמן שהאפליקציה מבצעת "Hydration" וטוענת נתונים, כדי למנוע הבהובים של תוכן לא רלוונטי ("Flash of Unstyled Content" או תצוגת לוגין רגעית).

- **קוד**:
  - `src/routes/+page.svelte`: הוספת מנגנון `isLoaded` המבוסס על `onMount` (לווידוא ריצה בצד הלקוח) ושימוש ב-`$effect` לביצוע הפניות ניווט ריאקטיביות. ההפניה האוטומטית מ-`/login` בוטלה לפי בקשת המשתמש.
  - `src/routes/login/+page.svelte`: דף חדש המארח את `UserSelector` ומטפל בכניסה למערכת.

### בדיקות ואימות

- **בדיקת דפדפן (סוכן אוטונומי)**:
  - בוצעה סימולציה של משתמש חדש (ניקוי `localStorage`).
  - וידוא שהגעה ל-`/` מפנה ל-`/login` (עם הצגת Splash Screen בדרך).
  - וידוא שבחירת משתמש ב-`/login` מפנה חזרה ל-`/` ומציגה את הלוח האישי.
  - צילומי מסך בוצעו לאימות ויזואלי של דף הלוגין ודף הבית לאחר כניסה.

---

## 2026-01-13: משוב קולי היברידי (TTS + קבצים)

### שינויים שבוצעו

- **שירותי אודיו**:
  - `src/lib/services/audioSequencer.ts`: שירות חדש לניגון רצף של מקטעי אודיו (קבצים ו-TTS משולבים).
  - `src/lib/services/boosts.ts`: עדכון `getFeedbackSequence` ליצירת רצף דינמי ("סיימת את [משימה]! [חיזוק]! עכשיו, [הבא בתור]"). שימוש בלוגיקה היברידית המעדיפה קבצי MP3 אם קיימים, ונופלת ל-TTS אם לא.
- **נתונים**:
  - הוספת קבצי קריינות חדשים (`static/sounds`) עבור חלקי המשפט המקשרים ("סיימת את...", "עכשיו...", "כל הכבוד").
- **UI**:
  - `+page.svelte`: אינטגרציה עם ה-Sequencer בעת סיום משימה, והארכת זמן הצגת הפופאפ ל-5 שניות.
- **תרגום הערות קוד**:
  - כל הערות הקוד (Comments) בפרויקט תורגמו מאנגלית לעברית, כולל Stores, Services, Logic, Components ו-Routes.

### בדיקות

- **קבצים**: וידוא שקבצים קיימים (`shower.mp3`) מתנגנים כחלק מהרצף.
- **TTS**: וידוא שמשימות ללא קבצים מוקראות ע"י הדפדפן.
- **רצף**: בדיקת המעברים בין חלקי המשפט.

## 2026-01-13: סנכרון פופ-אפ חגיגה ומבנה מודולרי

### שינויים שבוצעו

- **סנכרון ויזואלי-קולי**:
  - `TasksBoardController`: עודכן להמתין (`await`) לסיום רצף האודיו המלא לפני סגירת פופ-אפ החגיגה.
- **עיצוב מודולרי**:
  - `CelebrationModal.svelte`: המודאל הפך למובנה ומציג:
    1. כותרת "סיימת את [שם המשימה]"
    2. תמונת המשימה (בגדול)
    3. מחמאה (בטקסט בולט)
    4. "עכשיו, [שם המשימה הבאה]" + תמונה קטנה של המשימה הבאה.
  - `language.ts`: הפרדת הטקסטים והלוגיקה כדי להחזיר את המחמאה (`praise`) בנפרד לצורך תצוגה ויזואלית מודגשת.
- **תשתית נתונים**:
  - הגדרת `CelebrationData` המכיל את כל המידע הדרוש לתצוגה (תמונות, טקסטים, מגדר), מה שמונע תלות בלוגיקה בתוך הקומפוננטה.

### בדיקות

- **זרימה**: ברגע סיום משימה, הפופ-אפ נפתח, מציג את תמונת המשימה הנוכחית והבאה, והאודיו מתנגן בסנכרון.
- **סגירה**: הפופ-אפ נסגר אוטומטית _רק_ לאחר סיום הקריינות.
- **מקרי קצה**: טיפול במצב שבו אין משימה עוקבת (סיום יום).

---

## 2026-01-12: יישום אחסון תמונות ב-IndexedDB

### שינויים שבוצעו

- **שירותי אחסון**:
  - `src/lib/services/db.ts`: מעטפת ל-IndexedDB לשמירת Blob.
  - `src/lib/services/migration.ts`: מיגרציה אוטומטית מתמונות Base64 ל-IDB.
- **לוגיקת UI**:
  - `src/lib/actions/dbImage.ts`: פעולת Svelte לטעינה אסינכרונית של תמונות (Data URL -> Blob URL).
- **רכיבים**:
  - `AddModal.svelte`: שומר תמונות ל-DB מיידית בעת הבחירה.
  - `TaskRow.svelte`: משתמש ב-`dbImage` להצגת התמונות.
  - `appStore.svelte.ts`: מפעיל את המיגרציה בעת הטעינה.

### בדיקות ואימות

בוצע אימות ויזואלי באמצעות סריקת דפדפן אוטומטית:

1.  **הוספת תמונה מותאמת אישית (משימות, משתמשים, רשימות)**: סימולציה של העלאת קובץ עברה בהצלחה.
2.  **רכיב גנרי (`ImageUploader`)**: הוטמע בהצלחה ומשמש אחידות בכל המערכת.
3.  **בורר משתמשים**: מציג בהצלחה תמונות מפרופיל המשתמש ב-IndexedDB.

#### תיעוד ויזואלי

![מודל הוספה עם תצוגה מקדימה](add_task_modal_with_upload_preview_1768209965594.png)
![ניהול משתמשים - Avatar](verification_users_tab_1768210807339.png)
![ניהול רשימות - לוגו](verification_lists_tab_1768210817481.png)
![בורר משתמשים ראשי](verification_user_selector_1768210845352.png)
ושינויים

מסמך זה מתעד את התקדמות הפיתוח, שינויים מהותיים ומימושי פיצ'רים.

> [!NOTE]
> 2026-01-06 23:59

## שיפורים ויזואליים בממשק הניהול

שדרוג משמעותי של דף ההגדרות (`/settings`) לרמת גימור גבוהה ומודרנית.

### מה בוצע?

**1. עיצוב וממשק (UI/UX)**

- **עיצוב מעודכן**: הטמעת סגנון נקי ומודרני (Clean Look) עם שימוש בצלליות רכות (Shadows), פינות עגולות (Rounded Corners) וטיפוגרפיה ברורה.
- **אייקונים**: החלפת כפתורי הטקסט המיושנים (✎/🗑️) באייקוני SVG אינטואיטיביים ונגישים.
- **Grid Layout**: שימוש ב-CSS Grid לסידור רספונסיבי של כרטיסי המשתמשים והרשימות.

**2. שיפורים בטפסים (Forms)**

- **תצוגה מקדימה**: שיפור חווית הוספת משתמש ע"י הצגה ברורה של האווטאר הנבחר בתוך המודאל.
- **פוקוס**: הוספת אינדיקציה ויזואלית ברורה (Focus Ring) בעת מעבר בין שדות.

### החלטות ארכיטקטורה

- **[Vanilla CSS]**: המשכנו להשתמש ב-CSS רגיל בתוך רכיבי Svelte (`<style>`) כדי לשמור על פשטות ולא להוסיף תלות בספריות חיצוניות (כמו Tailwind) בשלב זה, אך השתמשנו במשתנים ודרכים מודרניות לכתיבה כדי להקל על תחזוקה עתידית.

---

> [!NOTE]
> 2026-01-06 21:40

## שיפורי הידר וברכות דינמיות

שיפור נראות ממשק ההידר והטמעת ברכות דינמיות המותאמות לרשימה הפעילה.

### מה בוצע?

**1. שיפורי ממשק (UI Improvements)**

- **אווטאר**: הוגדל מ-40px ל-56px. נוסף אפקט זום (Scale 2.2) במעבר עכבר לשיפור הראות וזיהוי המשתמש.
- **ניקיון**: הוסר הטקסט המיותר של שם המשתמש מתחת לאווטאר.

**2. מנגנון ברכות (Dynamic Greetings)**

- **ברכה מותאמת**: הטקסט ("בוקר טוב" / "אחרי צהריים טובים") נגזר כעת מהגדרת הרשימה הפעילה (`list.greeting`) ולא מקוד קשיח.
- **תמיכה בנתונים**: הוספת שדה `greeting` לממשק `List` ועדכון נתונים קיימים (Migration versions 4, 5) עם ערכי ברירת מחדל ("בהצלחה", "בוקר טוב").

**3. מיגרציה וריפקטור (Refactoring)**

- **migrateState**: הפרדת לוגיקת שדרוג הנתונים לפונקציה נפרדת ב-`appStore` כדי לשמור על `load()` נקי וקריא.

### החלטות ארכיטקטורה

- **[Dynamic Greeting Property]**: בחרנו לשמור את הברכה כמאפיין של הרשימה (`list.greeting`) ולא כחישוב לוגי (Computed). זה יאפשר בעתיד למשתמשים לערוך את הברכה לכל רשימה (למשל: "חופשה נעימה!" לרשימת חופש).

---

> [!NOTE]
> 2026-01-06 20:30

## יצירת אווטארים וארגון נכסים

הושלמה יצירת אווטארים אישיים בסגנון Pixar לכל הילדים ובוצע ארגון מחדש של הנכסים הסטטיים בפרויקט לתחזוקה קלה יותר.

### מה בוצע?

**1. יצירת אווטארים (Avatar Generation)**

- יצירת אווטארים לחברי המשפחה (תמר, יהונתן, אריאל) בתהליך דו-שלבי:
  1.  **Studio Portrait**: יצירת תמונת מקור ריאליסטית "נקייה" בסטודיו עם רקע לבן.
  2.  **Pixar Style**: המרה לדמות תלת-ממד בסגנון Pixar המבוססת על תמונת הסטודיו.
- האווטארים החדשים שולבו באפליקציה ב-`defaults.ts`.

**2. ארגון משאבים (Assets Reorganization)**

- **הפרדת סביבות**: יצירת תיקיית `resources_playground` (מחוץ ל-`static`) עבור חומרי גלם, ניסיונות גנרטיביים וקבצי מקור כבדים.
- **מבנה Static חדש**:
  - `static/images/activities/`: תמונות לפעילויות.
  - `static/images/times/`: אייקונים של זמני היום (בוקר/ערב).
  - `static/images/users/`: האווטארים הסופיים.
  - `static/sounds/ui/`: צלילי ממשק.
- **עדכון קוד**: עדכנו את כל הנתיבים בקוד (`defaults.ts`, `appStore.svelte.ts`, `AddModal.svelte` וכו') לעבודה עם המבנה החדש.

### החלטות ארכיטקטורה

- **[Playground Folder]**: בחרנו להוציא את ה-Raw Files מתוך `static` (ולמעשה מחוץ ל-Build של האפליקציה) כדי לא להכביד על ה-Deploy וכדי לשמור על הפרדה ברורה בין "חומרי עבודה" לבין "נכסי ייצור".

---

> [!NOTE]
> 2026-01-06 15:00

## תמיכה בריבוי משתמשים ושינויים מבניים

הוטמעה תמיכה מלאה בריבוי משתמשים ולוגיקת הליבה עברה לשירותים ייעודיים.

### מה בוצע?

**1. ריבוי משתמשים (User Management)**

- **מסך כניסה (UserSelector)**: יצירת מסך לבחירת המשתמש (תמר, יונתן, אריאל) עם תמיכה באווטארים.
- **התאמה אישית**: תמיכה במין (בן/בת) לברכות מותאמות ("אתה אלוף" / "את אלופה").
- **ניהול State**: יצירת `appStore.svelte.ts` - Store מרכזי המבוסס על Svelte 5 Runes לניהול כל המידע.
- **מיגרציה**: הוספת מנגנון המרה אוטומטי מנתונים ישנים (`my_lists`) למבנה החדש והמאוחד (`daily-schedule-data`).

**2. ריפקטורינג וניקיון קוד (Refactoring)**

- **הוצאת לוגיקה**: פיצול הלוגיקה המורכבת מ-`+page.svelte` לקבצים ייעודיים:
  - `src/lib/services/audio.ts`: ניהול השמעת סאונד.
  - `src/lib/logic/dragDrop.svelte.ts`: ניהול גרירה ושחרור (Drag & Drop) באמצעות מחלקה ייעודית.
- **ניהול נתונים (Data)**: הסרת התלות בקבצי JSON והעברת נתוני ברירת המחדל לקובץ טייפסקריפט `src/lib/data/defaults.ts`.

### החלטות ארכיטקטורה

- **[Unified LocalStorage]**: בחרנו לשמור את כל המידע (משתמשים, רשימות, הגדרות) באובייקט JSON יחיד בלוקל-סטורג'. הסיבה: פשטות בניהול גרסאות, גיבוי ושחזור, ומניעת חוסר תאימות בין מפתחות שונים.
- **[Composables / Runes Classes]**: בחרנו להוציא את לוגיקת ה-Drag&Drop למחלקה (`new DragDropManager`) שמקבלת Getters למצב העדכני. זה מאפשר לקוד הלוגי להישאר נקי מה-UI אך עדיין להגיב לשינויים ב-State (כמו `isEditMode`).

---

## [קודם] מיגרציה ל-Svelte 5 ולוקליזציה

(ראה למטה לשינויים היסטוריים...)
